name: Update Flatpak Manifest

on:
  push:
    tags:
      - '*'

jobs:
  update-manifest:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: master
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract tag name
        id: tag
        run: |
          TAG=${GITHUB_REF#refs/tags/}
          echo "TAG=$TAG" >> $GITHUB_ENV
          echo "tag=$TAG" >> $GITHUB_OUTPUT

      - name: Construct source archive URL
        run: |
          SOURCE_URL="https://github.com/yPhil-gh/Emulsion/archive/refs/tags/v${{ steps.tag.outputs.tag }}.tar.gz"
          echo "SOURCE_URL=$SOURCE_URL" >> $GITHUB_ENV

      - name: Download source archive
        run: |
          curl -L -o emulsion-source.tar.gz "$SOURCE_URL"

      - name: Compute SHA256
        id: sha
        run: |
          SHA256=$(sha256sum emulsion-source.tar.gz | awk '{print $1}')
          echo "SHA256=$SHA256" >> $GITHUB_ENV
          echo "sha256=$SHA256" >> $GITHUB_OUTPUT

      - name: Update manifest with new URL and SHA256
        run: |
          jq --arg url "$SOURCE_URL" --arg sha "${{ steps.sha.outputs.sha256 }}" \
            '.modules[] | select(.name == "emulsion").sources[] | select(.type == "archive").url = $url | .sha256 = $sha' \
            com.yPhil.Emulsion.json > tmp.json
          mv tmp.json com.yPhil.Emulsion.json

      - name: Commit and push updated manifest
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add com.yPhil.Emulsion.json
          git commit -m "chore(flatpak): update manifest for v${{ steps.tag.outputs.tag }}" || echo "No changes to commit"
          git push origin master
