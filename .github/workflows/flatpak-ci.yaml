name: Update Flatpak Manifest

on:
  push:
    tags:
      - '*'   # trigger on any tag push

jobs:
  update-manifest:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v3
        with:
          fetch-depth: 0   # needed so we can checkout master
          ref: master

      - name: Set variables
        run: |
          TAG=${GITHUB_REF#refs/tags/}
          echo "TAG=$TAG" >> $GITHUB_ENV
          echo "RELEASE_URL=https://github.com/yPhil-gh/Emulsion/releases/download/$TAG/emulsion_x86_64.AppImage" >> $GITHUB_ENV

      - name: Download AppImage
        run: curl -L -o emulsion.AppImage "$RELEASE_URL"

      - name: Compute SHA256
        run: |
          SHA256=$(sha256sum emulsion.AppImage | awk '{print $1}')
          echo "SHA256=$SHA256" >> $GITHUB_ENV

      - name: Update manifest JSON
        run: |
          jq --arg url "$RELEASE_URL" --arg sha "$SHA256" \
            '.modules[0].sources[0].url = $url | .modules[0].sources[0].sha256 = $sha' \
            com.yPhil.Emulsion.json > tmp.json
          mv tmp.json com.yPhil.Emulsion.json

      - name: Configure git with PAT and push
        env:
          PAT: ${{ secrets.FLATHUB_MANIFEST_TOKEN }}
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@users.noreply.github.com"

          # IMPORTANT: override the remote to inject PAT
          git remote set-url origin https://x-access-token:${{ secrets.FLATHUB_MANIFEST_TOKEN }}@github.com/yPhil-gh/com.yPhil.Emulsion.git

          git add com.yPhil.Emulsion.json
          git commit -m "Update manifest for $TAG" || echo "No changes to commit"
          git push origin master
